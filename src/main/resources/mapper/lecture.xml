<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tencoding.ADayOfLearning.repository.interfaces.LectureRepository"> 

	<insert id= "insert">
		INSERT INTO tb_lecture(category_id,user_id, title,content, address, address_detail, latitude, longitude, maximum, price, phone_number, state, created_at)
		values(#{categoryId},#{userId},#{title},#{content},#{address},#{addressDetail},#{latitude},#{longitude},#{maximum},#{price},#{phoneNumber},#{state},now());

		<selectKey resultType="java.lang.Integer" keyProperty="lectureId" order="AFTER">
       		 SELECT LAST_INSERT_ID()
    	</selectKey>
		
	</insert>
	
	<update id="updateByLectureId">
		UPDATE tb_lecture SET title = #{title}, content = #{content},
		address = #{address}, address_detail = #{addressDetail},
		latitude = #{latitude}, longitude = #{longitude},
		maximum = #{maximum},price = #{price}
		phone_number = #{phoneNumber},state = #{state}
		WHERE lecture_id = #{lectureId};
	</update>
	
	<delete id="deleteByLectureId">
		DELETE FROM tb_lecture WHERE lecture_id = #{lectureId};
	</delete>
	
	<select id="findByLectureId" resultType = "com.tencoding.ADayOfLearning.repository.model.Lecture">
		SELECT * FROM tb_lecture WHERE lecture_id = #{id}
	</select>
	
	<select id="findByAll" resultType = "com.tencoding.ADayOfLearning.repository.model.Lecture">
		SELECT * FROM tb_lecture;
	</select>
	
	<select id="findByStateAll" resultType = "com.tencoding.ADayOfLearning.dto.response.LectureListItemResponseDto">
		SELECT l.title, c.category_name, l.price, l.address, u.username, p.img
		FROM tb_lecture l 
		JOIN tb_category c ON l.category_id = c.category_id
		JOIN tb_user u ON l.user_id = u.user_id
        JOIN tb_lecture_photo p ON p.lecture_id = l.lecture_id
		WHERE l.state = 1 AND p.is_thumbnail = 1;
	</select>

<!-- 날짜가 포함안됨	 -->
<!-- 	<select id="findBySearch" resultType = "com.tencoding.ADayOfLearning.dto.response.LectureListItemResponseDto"> -->
<!-- 		SELECT l.lecture_id, l.title, c.category_name, l.price, l.address, u.username, p.img -->
<!-- 		FROM tb_lecture l  -->
<!-- 		JOIN tb_category c ON l.category_id = c.category_id -->
<!-- 		JOIN tb_user u ON l.user_id = u.user_id -->
<!--         JOIN tb_lecture_photo p ON p.lecture_id = l.lecture_id -->
<!--         WHERE l.state = 1 AND p.is_thumbnail = 1 -->
<!--         <if test="title != null"> -->
<!-- 			AND REPLACE(l.title, ' ', '') LIKE '%${title}%' -->
<!-- 		</if> -->
<!-- 		 <if test="categoryName != null"> -->
<!-- 			AND c.category_name = #{categoryName} -->
<!-- 		</if>	 -->
<!--          <if test="minPrice != null"> -->
<!-- 			AND l.price >= #{minPrice} -->
<!-- 		</if>	 -->
<!--          <if test="maxPrice != null"> -->
<!-- 			AND #{maxPrice} >= l.price -->
<!-- 		</if>	 -->
<!--          <if test="location != null"> -->
<!-- 			AND address LIKE '${location}%' -->
<!-- 		</if>	 -->
<!-- 	</select> -->
	
<!-- !!!날짜와 이미지가 안뿌려지는 테스트용!!! -->
	<select id="findBySearch" resultType = "com.tencoding.ADayOfLearning.dto.response.LectureListItemResponseDto">
		SELECT l.lecture_id, l.title, c.category_name, l.price, l.address, u.username
		FROM tb_lecture l 
		JOIN tb_category c ON l.category_id = c.category_id
		JOIN tb_user u ON l.user_id = u.user_id
        WHERE l.state = 1
        <if test="title != null">
			AND REPLACE(l.title, ' ', '') LIKE '%${title}%'
		</if>
		 <if test="categoryName != null">
			AND c.category_name = #{categoryName}
		</if>	
         <if test="minPrice != null">
			AND l.price >= #{minPrice}
		</if>	
         <if test="maxPrice != null">
			AND #{maxPrice} >= l.price
		</if>	
         <if test="location != null">
			AND address LIKE '${location}%'
		</if>	
	</select>



</mapper>